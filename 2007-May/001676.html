<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/linux-uvc-devel/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Issues%20with%20the%20Linux%20UVC%20driver%20%28Was%20%22Where%0A%09is%20V4L%20headed%20%3F%22%29&In-Reply-To=%3Cd9def9db0705060608u55546191l199c91813f397d56%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001674.html">
   <LINK REL="Next"  HREF="001677.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)</H1>
    <B>Markus Rechberger</B> 
    <A HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Issues%20with%20the%20Linux%20UVC%20driver%20%28Was%20%22Where%0A%09is%20V4L%20headed%20%3F%22%29&In-Reply-To=%3Cd9def9db0705060608u55546191l199c91813f397d56%40mail.gmail.com%3E"
       TITLE="[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)">mrechberger at gmail.com
       </A><BR>
    <I>Sun May  6 15:08:46 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001674.html">[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where is	V4L headed ?&quot;)
</A></li>
        <LI>Next message: <A HREF="001677.html">[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1676">[ date ]</a>
              <a href="thread.html#1676">[ thread ]</a>
              <a href="subject.html#1676">[ subject ]</a>
              <a href="author.html#1676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/6/07, Markus Rechberger &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">mrechberger at gmail.com</A>&gt; wrote:
&gt;<i> On 5/6/07, Laurent Pinchart &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">laurent.pinchart at skynet.be</A>&gt; wrote:
</I>&gt;<i> &gt; Let's move this discussion to the linux-uvc-devel list. I CCed
</I>&gt;<i> &gt; video4linux-list for reference, please reply to linux-uvc-devel only to
</I>&gt;<i> &gt; avoid
</I>&gt;<i> &gt; flooding the video4linux list.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Saturday 05 May 2007, Markus Rechberger wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; [snip non-uvc issues]
</I>&gt;<i> &gt; &gt; I'll just write all my considerations here, you can put the ML into CC
</I>&gt;<i> &gt; &gt; and/or split up the topics:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; 1.)
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: ekiga: page allocation failure.
</I>&gt;<i> &gt; &gt; order:10, mode:0x0
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [__alloc_pages+629/646]
</I>&gt;<i> &gt; &gt; __alloc_pages+0x275/0x286
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [__get_free_pages+26/51]
</I>&gt;<i> &gt; &gt; __get_free_pages+0x1a/0x33
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [dma_alloc_coherent+170/222]
</I>&gt;<i> &gt; &gt; dma_alloc_coherent+0xaa/0xde
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [pg0+513461816/1069679616]
</I>&gt;<i> &gt; &gt; uvc_init_video_bulk+0xb7/0x143 [uvcvideo]
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [pg0+513462425/1069679616]
</I>&gt;<i> &gt; &gt; uvc_video_enable+0xfe/0x121 [uvcvideo]
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [pg0+513458219/1069679616]
</I>&gt;<i> &gt; &gt; uvc_v4l2_do_ioctl+0x830/0x8bf [uvcvideo]
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [dput+24/373] dput+0x18/0x175
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [__link_path_walk+2824/3148]
</I>&gt;<i> &gt; &gt; __link_path_walk+0xb08/0xc4c
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [n_tty_receive_buf+3303/3378]
</I>&gt;<i> &gt; &gt; n_tty_receive_buf+0xce7/0xd32
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [get_page_from_freelist+635/798]
</I>&gt;<i> &gt; &gt; get_page_from_freelist+0x27b/0x31e
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [wakeup_kswapd+45/104]
</I>&gt;<i> &gt; &gt; wakeup_kswapd+0x2d/0x68 May  5 20:14:19 debian kernel:
</I>&gt;<i> &gt; &gt; [pg0+511673193/1069679616]
</I>&gt;<i> &gt; &gt; video_usercopy+0x112/0x1a3 [videodev]
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [vma_prio_tree_insert+23/42]
</I>&gt;<i> &gt; &gt; vma_prio_tree_insert+0x17/0x2a
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [vma_link+218/247] vma_link+0xda/0xf7
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [pg0+513458420/1069679616]
</I>&gt;<i> &gt; &gt; uvc_v4l2_ioctl+0x3a/0x40 [uvcvideo]
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [pg0+513456123/1069679616]
</I>&gt;<i> &gt; &gt; uvc_v4l2_do_ioctl+0x0/0x8bf [uvcvideo]
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [do_ioctl+76/98] do_ioctl+0x4c/0x62
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [vfs_ioctl+583/602]
</I>&gt;<i> vfs_ioctl+0x247/0x25a
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [sys_ioctl+51/76] sys_ioctl+0x33/0x4c
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  [syscall_call+7/11] syscall_call+0x7/0xb
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel:  =======================
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Mem-info:
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: DMA per-cpu:
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: CPU    0: Hot: hi:    0, btch:   1 usd:
</I>&gt;<i> &gt; &gt;   0   Cold: hi:    0, btch:   1 usd:   0
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Normal per-cpu:
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: CPU    0: Hot: hi:  186, btch:  31 usd:
</I>&gt;<i> &gt; &gt;  13   Cold: hi:   62, btch:  15 usd:  51
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Active:93485 inactive:7268 dirty:0
</I>&gt;<i> &gt; &gt; writeback:0 unstable:0 free:1171 slab:5255 mapped:15182 pagetables:980
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: DMA free:1928kB min:92kB low:112kB
</I>&gt;<i> &gt; &gt; high:136kB active:10716kB inactive:0kB present:16256kB
</I>&gt;<i> &gt; &gt; pages_scanned:429 all_unreclaimable? no
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: lowmem_reserve[]: 0 459
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Normal free:2756kB min:2692kB
</I>&gt;<i> &gt; &gt; low:3364kB high:4036kB active:363224kB inactive:29072kB
</I>&gt;<i> &gt; &gt; present:470284kB pages_scanned:291 all_unreclaimable? no
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: lowmem_reserve[]: 0 0
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: DMA: 4*4kB 1*8kB 1*16kB 1*32kB 1*64kB
</I>&gt;<i> &gt; &gt; 0*128kB 1*256kB 1*512kB 1*1024kB 0*2048kB 0*4096kB = 1928kB
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Normal: 47*4kB 5*8kB 12*16kB 3*32kB
</I>&gt;<i> &gt; &gt; 1*64kB 1*128kB 0*256kB 0*512kB 0*1024kB 1*2048kB 0*4096kB = 2756kB
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Swap cache: add 440134, delete 421407,
</I>&gt;<i> &gt; &gt; find 136779/175577, race 0+0
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Free swap  = 455676kB
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Total swap = 976888kB
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: Free swap:       455676kB
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 122592 pages of RAM
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 0 pages of HIGHMEM
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 1844 reserved pages
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 70305 pages shared
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 18727 pages swap cached
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 0 pages dirty
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 0 pages writeback
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 15182 pages mapped
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 5253 pages slab
</I>&gt;<i> &gt; &gt; May  5 20:14:19 debian kernel: 980 pages pagetables
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; This happens either if a box has 256 mb ram, or is almost out of
</I>&gt;<i> &gt; &gt; physical memory.
</I>&gt;<i> &gt; &gt; The other driver I have works properly with it. After a fresh reboot
</I>&gt;<i> &gt; &gt; the uvcvideo driver seems to work for a while.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Oh, an OOM issue.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The driver allocates memory for bulk/isochronous transfers based on two
</I>&gt;<i> &gt; parameters. The first one is the maximum payload transfer size, as
</I>&gt;<i> reported
</I>&gt;<i> &gt; by the device. I can't do much about that one. The second one is the
</I>&gt;<i> number
</I>&gt;<i> &gt; of URBs allocated by the driver. This is currently hardcoded to 5, but
</I>&gt;<i> could
</I>&gt;<i> &gt; be made configurable or could be computed based on the maximum payload
</I>&gt;<i> &gt; transfer size. I'll look into this issue.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> this really seems to be an issue with usb_buffer_alloc() after that
</I>&gt;<i> call fails the whole memory management goes dizzy.
</I>&gt;<i> It tries to swap out almost all the physical memory hangs for a while
</I>&gt;<i> and copies the swapped memory back to physical memory till it becomes
</I>&gt;<i> normal again.
</I>&gt;<i> I also see that more than half of the system memory is used as cache,
</I>&gt;<i> since usb_buffer_alloc is called with GFP_KERNEL it might wait until
</I>&gt;<i> some cache memory gets released for it. I added Greg to that mail
</I>&gt;<i> since I think that he knows alot about the usb framework itself.
</I>&gt;<i>
</I>&gt;<i>  dwMaxVideoFrameBufferSize     2752512 (which is used for
</I>&gt;<i> usb_buffer_alloc, seems to be too much already)
</I>&gt;<i>
</I>&gt;<i> I don't have a problem with that in my uvc driver since I only
</I>&gt;<i> allocate memory for max. 640x480 and do not support a higher mode.
</I>&gt;<i>
</I>&gt;<i> &gt; Could you please post the output of lsusb -v (with usbutils 0.72 or later)
</I>&gt;<i> ?
</I>&gt;<i> &gt; Thanks.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> (think that value was what you were looking for)
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; 2.) No v4l1 support using the compat layer
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I read some discussions about not supporting v4l1, as a point from the
</I>&gt;<i> &gt; &gt; userside it simply has to work and there are still applications out
</I>&gt;<i> &gt; &gt; there which only support v4l1, I read that a compat version of that
</I>&gt;<i> &gt; &gt; driver is available but you don't want it in the main driver.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The Linux UVC driver calls v4l_compat_translate_ioctl() for all
</I>&gt;<i> non-handled
</I>&gt;<i> &gt; ioctls. The compat layer is thus used. It seems the problem comes from a
</I>&gt;<i> &gt; required v4l1 ioctl not handled properly by the compat layer. I haven't
</I>&gt;<i> &gt; looked into that issue, as I don't plan to support v4l1 explicitly in the
</I>&gt;<i> &gt; driver.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> as for my drivers I always saw this as an open issue too, there is no
</I>&gt;<i> reason to not add support for it at least, it just requires a few more
</I>&gt;<i> ioctl controls.
</I>&gt;<i>
</I>&gt;<i> &gt; &gt; 3.) Some controls are missing, for example mplayer isn't supported by
</I>&gt;<i> &gt; &gt; just running
</I>&gt;<i> &gt; &gt; mplayer -tv driver=v4l2 <A HREF="tv://">tv://</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; mplayer is buggy. It doesn't set the v4l2_buffer.memory field prior to
</I>&gt;<i> &gt; dequeuing buffers, as required by the v4l2 specification. I think a patch
</I>&gt;<i> &gt; has
</I>&gt;<i> &gt; been applied to the mplayer repository to fix this issue.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> I see xawtv doesn't work either here, the em28xx driver works with
</I>&gt;<i> both without the need of any patches. xawtv is used as a reference for
</I>&gt;<i> some other userspace applications since it has been available for a
</I>&gt;<i> very long time already.
</I>&gt;<i>
</I>
just tested mplayer (latest svn) it doesn't work either

&gt;<i> &gt; &gt; 4.) read() isn't supported
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; That's right, and this is definitely a shortcomming. I plan to support
</I>&gt;<i> &gt; read(),
</I>&gt;<i> &gt; but this hasn't been done yet. If you need read() support for a specific
</I>&gt;<i> &gt; application, we could work together to add it to the driver as quickly as
</I>&gt;<i> &gt; possible.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; 5.) I'd like to share common code between usb video devices, the
</I>&gt;<i> &gt; &gt; em28xx driver supports slicing the video and piping a part of the
</I>&gt;<i> &gt; &gt; video to /dev/vbi for example (raw vbi).
</I>&gt;<i> &gt; &gt; 6.) Mauro also wrote some ideas about having a general usb framework
</I>&gt;<i> &gt; &gt; since all devices share common parts.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; these points would be part of the agenda which I'd like to discuss
</I>&gt;<i> &gt; &gt; with you and Mauro actually.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I plan to see if I can use video-buf in the Linux UVC driver. However,
</I>&gt;<i> this
</I>&gt;<i> &gt; might not be beneficial to all users. The buffer queue code in the UVC
</I>&gt;<i> &gt; driver
</I>&gt;<i> &gt; is USB-specific, and is thus smaller than video-buf. Users who currently
</I>&gt;<i> &gt; don't use video-buf would see their memory usage grow.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Laurent Pinchart
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> (I'll answer the other issues later)
</I>&gt;<i>
</I>&gt;<i> Markus
</I>&gt;<i>
</I>

-- 
Markus Rechberger

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001674.html">[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where is	V4L headed ?&quot;)
</A></li>
	<LI>Next message: <A HREF="001677.html">[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1676">[ date ]</a>
              <a href="thread.html#1676">[ thread ]</a>
              <a href="subject.html#1676">[ subject ]</a>
              <a href="author.html#1676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">More information about the Linux-uvc-devel
mailing list</a><br>
</body></html>
