<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where is	V4L headed ?&quot;)
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/linux-uvc-devel/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Issues%20with%20the%20Linux%20UVC%20driver%20%28Was%20%22Where%20is%0A%09V4L%20headed%20%3F%22%29&In-Reply-To=%3C200705061308.16859.laurent.pinchart%40skynet.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001670.html">
   <LINK REL="Next"  HREF="001676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where is	V4L headed ?&quot;)</H1>
    <B>Laurent Pinchart</B> 
    <A HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Issues%20with%20the%20Linux%20UVC%20driver%20%28Was%20%22Where%20is%0A%09V4L%20headed%20%3F%22%29&In-Reply-To=%3C200705061308.16859.laurent.pinchart%40skynet.be%3E"
       TITLE="[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where is	V4L headed ?&quot;)">laurent.pinchart at skynet.be
       </A><BR>
    <I>Sun May  6 13:08:16 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="001670.html">[Linux-uvc-devel] program compatibilty
</A></li>
        <LI>Next message: <A HREF="001676.html">[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1674">[ date ]</a>
              <a href="thread.html#1674">[ thread ]</a>
              <a href="subject.html#1674">[ subject ]</a>
              <a href="author.html#1674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Let's move this discussion to the linux-uvc-devel list. I CCed 
video4linux-list for reference, please reply to linux-uvc-devel only to avoid 
flooding the video4linux list.

On Saturday 05 May 2007, Markus Rechberger wrote:

[snip non-uvc issues]
&gt;<i> I'll just write all my considerations here, you can put the ML into CC 
</I>&gt;<i> and/or split up the topics:
</I>&gt;<i>
</I>&gt;<i> 1.)
</I>&gt;<i> May  5 20:14:19 debian kernel: ekiga: page allocation failure.
</I>&gt;<i> order:10, mode:0x0
</I>&gt;<i> May  5 20:14:19 debian kernel:  [__alloc_pages+629/646]
</I>&gt;<i> __alloc_pages+0x275/0x286
</I>&gt;<i> May  5 20:14:19 debian kernel:  [__get_free_pages+26/51]
</I>&gt;<i> __get_free_pages+0x1a/0x33
</I>&gt;<i> May  5 20:14:19 debian kernel:  [dma_alloc_coherent+170/222]
</I>&gt;<i> dma_alloc_coherent+0xaa/0xde
</I>&gt;<i> May  5 20:14:19 debian kernel:  [pg0+513461816/1069679616]
</I>&gt;<i> uvc_init_video_bulk+0xb7/0x143 [uvcvideo]
</I>&gt;<i> May  5 20:14:19 debian kernel:  [pg0+513462425/1069679616]
</I>&gt;<i> uvc_video_enable+0xfe/0x121 [uvcvideo]
</I>&gt;<i> May  5 20:14:19 debian kernel:  [pg0+513458219/1069679616]
</I>&gt;<i> uvc_v4l2_do_ioctl+0x830/0x8bf [uvcvideo]
</I>&gt;<i> May  5 20:14:19 debian kernel:  [dput+24/373] dput+0x18/0x175
</I>&gt;<i> May  5 20:14:19 debian kernel:  [__link_path_walk+2824/3148]
</I>&gt;<i> __link_path_walk+0xb08/0xc4c
</I>&gt;<i> May  5 20:14:19 debian kernel:  [n_tty_receive_buf+3303/3378]
</I>&gt;<i> n_tty_receive_buf+0xce7/0xd32
</I>&gt;<i> May  5 20:14:19 debian kernel:  [get_page_from_freelist+635/798]
</I>&gt;<i> get_page_from_freelist+0x27b/0x31e
</I>&gt;<i> May  5 20:14:19 debian kernel:  [wakeup_kswapd+45/104]
</I>&gt;<i> wakeup_kswapd+0x2d/0x68 May  5 20:14:19 debian kernel: 
</I>&gt;<i> [pg0+511673193/1069679616]
</I>&gt;<i> video_usercopy+0x112/0x1a3 [videodev]
</I>&gt;<i> May  5 20:14:19 debian kernel:  [vma_prio_tree_insert+23/42]
</I>&gt;<i> vma_prio_tree_insert+0x17/0x2a
</I>&gt;<i> May  5 20:14:19 debian kernel:  [vma_link+218/247] vma_link+0xda/0xf7
</I>&gt;<i> May  5 20:14:19 debian kernel:  [pg0+513458420/1069679616]
</I>&gt;<i> uvc_v4l2_ioctl+0x3a/0x40 [uvcvideo]
</I>&gt;<i> May  5 20:14:19 debian kernel:  [pg0+513456123/1069679616]
</I>&gt;<i> uvc_v4l2_do_ioctl+0x0/0x8bf [uvcvideo]
</I>&gt;<i> May  5 20:14:19 debian kernel:  [do_ioctl+76/98] do_ioctl+0x4c/0x62
</I>&gt;<i> May  5 20:14:19 debian kernel:  [vfs_ioctl+583/602] vfs_ioctl+0x247/0x25a
</I>&gt;<i> May  5 20:14:19 debian kernel:  [sys_ioctl+51/76] sys_ioctl+0x33/0x4c
</I>&gt;<i> May  5 20:14:19 debian kernel:  [syscall_call+7/11] syscall_call+0x7/0xb
</I>&gt;<i> May  5 20:14:19 debian kernel:  =======================
</I>&gt;<i> May  5 20:14:19 debian kernel: Mem-info:
</I>&gt;<i> May  5 20:14:19 debian kernel: DMA per-cpu:
</I>&gt;<i> May  5 20:14:19 debian kernel: CPU    0: Hot: hi:    0, btch:   1 usd:
</I>&gt;<i>   0   Cold: hi:    0, btch:   1 usd:   0
</I>&gt;<i> May  5 20:14:19 debian kernel: Normal per-cpu:
</I>&gt;<i> May  5 20:14:19 debian kernel: CPU    0: Hot: hi:  186, btch:  31 usd:
</I>&gt;<i>  13   Cold: hi:   62, btch:  15 usd:  51
</I>&gt;<i> May  5 20:14:19 debian kernel: Active:93485 inactive:7268 dirty:0
</I>&gt;<i> writeback:0 unstable:0 free:1171 slab:5255 mapped:15182 pagetables:980
</I>&gt;<i> May  5 20:14:19 debian kernel: DMA free:1928kB min:92kB low:112kB
</I>&gt;<i> high:136kB active:10716kB inactive:0kB present:16256kB
</I>&gt;<i> pages_scanned:429 all_unreclaimable? no
</I>&gt;<i> May  5 20:14:19 debian kernel: lowmem_reserve[]: 0 459
</I>&gt;<i> May  5 20:14:19 debian kernel: Normal free:2756kB min:2692kB
</I>&gt;<i> low:3364kB high:4036kB active:363224kB inactive:29072kB
</I>&gt;<i> present:470284kB pages_scanned:291 all_unreclaimable? no
</I>&gt;<i> May  5 20:14:19 debian kernel: lowmem_reserve[]: 0 0
</I>&gt;<i> May  5 20:14:19 debian kernel: DMA: 4*4kB 1*8kB 1*16kB 1*32kB 1*64kB
</I>&gt;<i> 0*128kB 1*256kB 1*512kB 1*1024kB 0*2048kB 0*4096kB = 1928kB
</I>&gt;<i> May  5 20:14:19 debian kernel: Normal: 47*4kB 5*8kB 12*16kB 3*32kB
</I>&gt;<i> 1*64kB 1*128kB 0*256kB 0*512kB 0*1024kB 1*2048kB 0*4096kB = 2756kB
</I>&gt;<i> May  5 20:14:19 debian kernel: Swap cache: add 440134, delete 421407,
</I>&gt;<i> find 136779/175577, race 0+0
</I>&gt;<i> May  5 20:14:19 debian kernel: Free swap  = 455676kB
</I>&gt;<i> May  5 20:14:19 debian kernel: Total swap = 976888kB
</I>&gt;<i> May  5 20:14:19 debian kernel: Free swap:       455676kB
</I>&gt;<i> May  5 20:14:19 debian kernel: 122592 pages of RAM
</I>&gt;<i> May  5 20:14:19 debian kernel: 0 pages of HIGHMEM
</I>&gt;<i> May  5 20:14:19 debian kernel: 1844 reserved pages
</I>&gt;<i> May  5 20:14:19 debian kernel: 70305 pages shared
</I>&gt;<i> May  5 20:14:19 debian kernel: 18727 pages swap cached
</I>&gt;<i> May  5 20:14:19 debian kernel: 0 pages dirty
</I>&gt;<i> May  5 20:14:19 debian kernel: 0 pages writeback
</I>&gt;<i> May  5 20:14:19 debian kernel: 15182 pages mapped
</I>&gt;<i> May  5 20:14:19 debian kernel: 5253 pages slab
</I>&gt;<i> May  5 20:14:19 debian kernel: 980 pages pagetables
</I>&gt;<i>
</I>&gt;<i> This happens either if a box has 256 mb ram, or is almost out of
</I>&gt;<i> physical memory.
</I>&gt;<i> The other driver I have works properly with it. After a fresh reboot
</I>&gt;<i> the uvcvideo driver seems to work for a while.
</I>
Oh, an OOM issue.

The driver allocates memory for bulk/isochronous transfers based on two 
parameters. The first one is the maximum payload transfer size, as reported 
by the device. I can't do much about that one. The second one is the number 
of URBs allocated by the driver. This is currently hardcoded to 5, but could 
be made configurable or could be computed based on the maximum payload 
transfer size. I'll look into this issue.

Could you please post the output of lsusb -v (with usbutils 0.72 or later) ? 
Thanks.

&gt;<i> 2.) No v4l1 support using the compat layer
</I>&gt;<i>
</I>&gt;<i> I read some discussions about not supporting v4l1, as a point from the
</I>&gt;<i> userside it simply has to work and there are still applications out
</I>&gt;<i> there which only support v4l1, I read that a compat version of that
</I>&gt;<i> driver is available but you don't want it in the main driver.
</I>
The Linux UVC driver calls v4l_compat_translate_ioctl() for all non-handled 
ioctls. The compat layer is thus used. It seems the problem comes from a 
required v4l1 ioctl not handled properly by the compat layer. I haven't 
looked into that issue, as I don't plan to support v4l1 explicitly in the 
driver.

&gt;<i> 3.) Some controls are missing, for example mplayer isn't supported by
</I>&gt;<i> just running
</I>&gt;<i> mplayer -tv driver=v4l2 <A HREF="tv://">tv://</A>
</I>
mplayer is buggy. It doesn't set the v4l2_buffer.memory field prior to 
dequeuing buffers, as required by the v4l2 specification. I think a patch has 
been applied to the mplayer repository to fix this issue.

&gt;<i> 4.) read() isn't supported
</I>
That's right, and this is definitely a shortcomming. I plan to support read(), 
but this hasn't been done yet. If you need read() support for a specific 
application, we could work together to add it to the driver as quickly as 
possible.

&gt;<i> 5.) I'd like to share common code between usb video devices, the
</I>&gt;<i> em28xx driver supports slicing the video and piping a part of the
</I>&gt;<i> video to /dev/vbi for example (raw vbi).
</I>&gt;<i> 6.) Mauro also wrote some ideas about having a general usb framework
</I>&gt;<i> since all devices share common parts.
</I>&gt;<i>
</I>&gt;<i> these points would be part of the agenda which I'd like to discuss
</I>&gt;<i> with you and Mauro actually.
</I>
I plan to see if I can use video-buf in the Linux UVC driver. However, this 
might not be beneficial to all users. The buffer queue code in the UVC driver 
is USB-specific, and is thus smaller than video-buf. Users who currently 
don't use video-buf would see their memory usage grow.

Laurent Pinchart

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001670.html">[Linux-uvc-devel] program compatibilty
</A></li>
	<LI>Next message: <A HREF="001676.html">[Linux-uvc-devel] Issues with the Linux UVC driver (Was &quot;Where	is V4L headed ?&quot;)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1674">[ date ]</a>
              <a href="thread.html#1674">[ thread ]</a>
              <a href="subject.html#1674">[ subject ]</a>
              <a href="author.html#1674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">More information about the Linux-uvc-devel
mailing list</a><br>
</body></html>
