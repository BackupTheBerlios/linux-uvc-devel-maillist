<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Linux-uvc-devel] Quanta integrated webcam
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/linux-uvc-devel/2011-June/index.html" >
   <LINK REL="made" HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Quanta%20integrated%20webcam&In-Reply-To=%3Calpine.LNX.2.00.1106171433120.26141%40tristan%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006628.html">
   <LINK REL="Next"  HREF="006630.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Linux-uvc-devel] Quanta integrated webcam</H1>
    <B>Carl Michal</B> 
    <A HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Quanta%20integrated%20webcam&In-Reply-To=%3Calpine.LNX.2.00.1106171433120.26141%40tristan%3E"
       TITLE="[Linux-uvc-devel] Quanta integrated webcam">michal at physics.ubc.ca
       </A><BR>
    <I>Fri Jun 17 23:33:25 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="006628.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
        <LI>Next message: <A HREF="006630.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6629">[ date ]</a>
              <a href="thread.html#6629">[ thread ]</a>
              <a href="subject.html#6629">[ subject ]</a>
              <a href="author.html#6629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 17 Jun 2011, Carl Michal wrote:

&gt;<i>
</I>&gt;<i> On Thu, 16 Jun 2011, Alexey Fisher wrote:
</I>&gt;<i>
</I>&gt;&gt;<i>  Am Donnerstag, den 16.06.2011, 11:31 -0700 schrieb Carl Michal:
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt;  On Thu, 16 Jun 2011, Carl Michal wrote:
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  On Wed, 15 Jun 2011, Alexey Fisher wrote:
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt;   Am Dienstag, den 14.06.2011, 23:31 -0700 schrieb Carl Michal:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   On Tue, 14 Jun 2011, Alexey Fisher wrote:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   Am Montag, den 13.06.2011, 22:48 -0700 schrieb Carl Michal:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   Hi,
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   I think you nailed it.  Every frame looks perfect now.  The 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   trace
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   shows a few
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   of these:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   Jun 13 09:24:24 uvcvideo: Dropping payload (error bit set)
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   but I don't see corrupt frames any more in either MJPG or 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   YUYV (at
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   640x480
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   anyway) - in MJPG all the frames have the right size.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   There is a some weirdness with frame rates depending on the
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   exposure setting:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   1) Exposure, auto gives 4 options: auto priority mode, 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   manual
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   mode, shutter
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   priority mode, and aperture priority mode.  Auto and 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   shutter don't
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   seem to be
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   settable (errors from guvcview when chosen). There is also 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   an
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   &quot;Exposure, auto
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   priority&quot; checkbox.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   Frame rates drop dramatically in manual mode (to 10-15fps 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   from
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   30).
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   But I can't really complain at this point - the corrupt 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   frames are
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   gone.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   Will that quirk be added to the driver (usb id is: 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   0408:2fb1)?
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt;   Thanks,
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   Hi,
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   it seems like I am much better off by fully disabling FID 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   (with your
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   patch) than before.  With the patch, YUYV frames are _always_ 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   the
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   right
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   size.  There are still some problems:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   1) corrupt frames - with part of the image missing or the 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   image
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   displaced.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   Sometimes (but definitely not always) these occur at the same 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   time
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   as a
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   trace message saying the error bit is set.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   2) sometimes the camera just won't start.  when guvcview (or
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   luvcview) is
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   started, no frames come back from the camera.  There is a 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   light next
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   to
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   the camera that comes on to indicate it should be active, but 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   no
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   frames
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   arrive.  There seems to be a fairly strong correlation with 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   using
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   luvcview
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   (which from the traces seems to use some different mechanism 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   to get
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   frames from
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   the driver from guvcview.  guvcview polls, luvcview doesn't).
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   Sometimes
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   just restarting guvcview several times will work and the 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   camera
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   eventually
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   starts.  Sometimes just changing resolution or frame rates 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   succeeds
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   in
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   starting the camera.  I haven't found anything reproducible. 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   I do
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   not
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   think this is related to your patch, as it did happen once 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   before
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   your
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   patch was applied. Unloading and reloading the uvcvideo and 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   ehci_hcd
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   modules does not consistently solve it. guvcview just lists:
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;     Could not grab image (select timeout): Resource temporarily
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;     unavailable
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   and the trace shows guvcview polling, but nothing else going 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   on.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   I have tried adding the other quirks to the FID quirk, but 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   haven't
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   seen
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   any improvement with any others.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   Thanks for you help -
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; &gt;   Carl
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   Webcam returns error in the middle of some frame, theoretically 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   we
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   should drop complete frame. But current uvcvideo just gather 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   data and
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   assume the cam will resend previous parts to complete the 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   frame.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   Try attached patch additionally to my previous one.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   --
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;   Regards,
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt;          Alexey
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   Hi,
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   its very hard to say if this helps or not.  There are still 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   corrupt
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   frames, and some seem to occur at about the same time as the 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   error bit
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   trace messages, but some don't show anything unusual in the 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   traces that
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   I've noticed yet.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   Since all the uncompressed frames were the right size (even ones 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   where
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   the
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   error bit was set somewhere) those frames are at least complete.
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   Is there some convenient way to capture just those frames with 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   the error
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   bit set?
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   Thanks,
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt;   Carl
</I>&gt;&gt;<i> &gt; &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt;   you can try this command:
</I>&gt;&gt;<i> &gt; &gt; &gt;   gst-launch-0.10 -v v4l2src ! video/x-raw-yuv,width=320 ! identity !
</I>&gt;&gt;<i> &gt; &gt; &gt;   jpegenc ! multifilesink location=tmp-%05d.jpg
</I>&gt;&gt;<i> &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt;   it will produce for each frame one jpeg file. Watch out, it will 
</I>&gt;&gt;<i> &gt; &gt; &gt;   produce
</I>&gt;&gt;<i> &gt; &gt; &gt;   lots of files.
</I>&gt;&gt;<i> &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt;   Attached patch is replacement for the last one. You do not need 
</I>&gt;&gt;<i> &gt; &gt; &gt;   setting
</I>&gt;&gt;<i> &gt; &gt; &gt;   trace option, it will print all we need.
</I>&gt;&gt;<i> &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt; &gt;   --
</I>&gt;&gt;<i> &gt; &gt; &gt;   Regards,
</I>&gt;&gt;<i> &gt; &gt; &gt;          Alexey
</I>&gt;&gt;<i> &gt; &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  Hi,
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  we're learning a little here.  If I set nodrop=1, I get lots of frames 
</I>&gt;&gt;<i> &gt; &gt;  that
</I>&gt;&gt;<i> &gt; &gt;  are too short (gst complains that they are fewer bytes than expected) 
</I>&gt;&gt;<i> &gt; &gt;  but
</I>&gt;&gt;<i> &gt; &gt;  those coincide with the status &lt; 0 test in uvc_video_decode_isoc - 
</I>&gt;&gt;<i> &gt; &gt;  they do
</I>&gt;&gt;<i> &gt; &gt;  not correspond to those with the error bit set.
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  The buf-&gt;error=1 in uvc_video_decode_start=1 is unnecessary - harmful 
</I>&gt;&gt;<i> &gt; &gt;  even,
</I>&gt;&gt;<i> &gt; &gt;  since it means dropping frames that are in fact ok.
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  I have captured some bad frames though - one that has the colors badly
</I>&gt;&gt;<i> &gt; &gt;  screwed up - where everything is a bright green, and another where the 
</I>&gt;&gt;<i> &gt; &gt;  image
</I>&gt;&gt;<i> &gt; &gt;  appears to be shifted about a quarter of a frame to one side - these 
</I>&gt;&gt;<i> &gt; &gt;  were
</I>&gt;&gt;<i> &gt; &gt;  collected without the nodrop=1 parameter, so they are not caught as 
</I>&gt;&gt;<i> &gt; &gt;  corrupt
</I>&gt;&gt;<i> &gt; &gt;  by any of the current tests. They are delivered as occuring with the 
</I>&gt;&gt;<i> &gt; &gt;  full
</I>&gt;&gt;<i> &gt; &gt;  expected frame size. Are there other flags we should be checking for? 
</I>&gt;&gt;<i> &gt; &gt;  (hmm,
</I>&gt;&gt;<i> &gt; &gt;  like maybe an FID at the wrong time?)
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  Carl
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; &gt;  _______________________________________________
</I>&gt;&gt;<i> &gt; &gt;  Linux-uvc-devel mailing list
</I>&gt;&gt;<i> &gt; &gt;  <A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">Linux-uvc-devel at lists.berlios.de</A>
</I>&gt;&gt;<i> &gt; &gt;  <A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">https://lists.berlios.de/mailman/listinfo/linux-uvc-devel</A>
</I>&gt;&gt;<i> &gt; &gt; 
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt;  Hi,
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt;  this gets weirder.  Dropping frames where the FID bit is toggled
</I>&gt;&gt;<i> &gt;  unexpectedly looks like it drops lots of good frames, and not all the 
</I>&gt;&gt;<i> &gt;  bad
</I>&gt;&gt;<i> &gt;  ones. But this is not so easy - capturing frames with gstreamer actually
</I>&gt;&gt;<i> &gt;  seems relatively reliable in any case.  The fraction of bad frames
</I>&gt;&gt;<i> &gt;  generated seems to depend quite a bit on what program is used - guvcview
</I>&gt;&gt;<i> &gt;  and luvcview produce many more than gstreamer.
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt;  I put in checks at the begining of uvc_video_decode_start to look at 
</I>&gt;&gt;<i> &gt;  other
</I>&gt;&gt;<i> &gt;  bits in the header, and found that the camera does occasionally return 
</I>&gt;&gt;<i> &gt;  the
</I>&gt;&gt;<i> &gt;  STI bit and RES bit set, and sometimes doesn't set the EOH.  These 
</I>&gt;&gt;<i> &gt;  usually
</I>&gt;&gt;<i> &gt;  happen together, but sometimes just one or two of these bits is
</I>&gt;&gt;<i> &gt;  unexpected. Dropping frames with any one of those unexpected *seems* to
</I>&gt;&gt;<i> &gt;  help, but there are still occasional bad frames.
</I>&gt;&gt;<i> &gt; 
</I>&gt;&gt;<i> &gt;  If EOH is not set does that mean there is more header somewhere?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  Do you mean EOH or EOF?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  can you please send me one sample of brocken frame, row, not jpeg. Use
</I>&gt;&gt;<i>  &quot;luvcview -C&quot; to capture frames. It will probably use 640x480 in YUV by
</I>&gt;&gt;<i>  default. YOu will get lots of files. To convert it in jpeg you can use
</I>&gt;&gt;<i>  gstreamer:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  for i in *.raw; do gst-launch-0.10 filesrc location=$i ! videoparse
</I>&gt;&gt;<i>  format=3 width=640 height=480 ! jpegenc ! filesink location=$i.jpg; done
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  --
</I>&gt;&gt;<i>  Regards,
</I>&gt;&gt;<i>         Alexey
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> ok - I've put a few frames here:
</I>&gt;<i> <A HREF="http://www.phas.ubc.ca/~michal/Frames/">http://www.phas.ubc.ca/~michal/Frames/</A>
</I>&gt;<i>
</I>&gt;<i> These are 1280x720.  With the first patch (to fully ignore FID toggling) 
</I>&gt;<i> collecting frames with
</I>&gt;<i> luvcview -C -f -s 640x480
</I>&gt;<i> gives no bad frames in a few minutes of collecting.  But going to 1280x720 
</I>&gt;<i> gives anywhere between 2-50 bad frames in 2 minutes.  These are without the 
</I>&gt;<i> nodrop=1 parameter.  If I add nodrop=1 the number of bad frames increases 
</I>&gt;<i> dramatically.  There are overflow errors and some frames get dropped from the 
</I>&gt;<i> status&lt;0 test.
</I>&gt;<i>
</I>&gt;<i> The three frames I saved there were collected without nodrop=1, and with both 
</I>&gt;<i> the first and third patches - so FID is ignored, and any frame that had an 
</I>&gt;<i> error bit set is dropped.
</I>&gt;<i>
</I>&gt;<i> I noticed that when the error bit is set, sometimes EOF is also set - I 
</I>&gt;<i> wonder if EOF + ERROR means &quot;give up on this frame and go on to the next?&quot; It 
</I>&gt;<i> looks like the driver currently ignores EOF if ERROR is set.
</I>&gt;<i>
</I>&gt;<i> It appears to me that EOH (yes EOH) is generally set, but occasionally it is 
</I>&gt;<i> not. I don't see why STI or RES should ever be set - is there some 
</I>&gt;<i> possibility that bytes that are not header are being misinterpreted as 
</I>&gt;<i> header?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Carl
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Linux-uvc-devel mailing list
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">Linux-uvc-devel at lists.berlios.de</A>
</I>&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">https://lists.berlios.de/mailman/listinfo/linux-uvc-devel</A>
</I>&gt;<i>
</I>&gt;<i>
</I>This looks deeper -

I've been looking at lengths of packets and headers in packets where these 
unexpected STI, RES, EOH and ERROR bits are set.

There are many things that seem inconsistent, but there are some patterns 
that come up repeatedly.  For example getting a packet with an ERROR bit 
set that has a length of 2048 and a header length (from data[0]) of 127 or 
125 or 110 or some other big number. That packet gets discarded because of 
the error bit, but then when the frame ends, it is 2048 bytes shorter than 
it should be.  I've also seen that with a packet length of 1024 and the 
frame ending 1024 bytes short.

It looks like the header has somehow disappeared and the image data is 
being interpreted as header.  To test this, I put in checks in 
uvc_video_decode_isoc for any EOH, STI, RES or ERROR - if any are set (or 
unset for EOH) then to return a header length of 0, so that the entire 
packet gets used as image data.

This by no means solves all my problems, but with that - I do find at 
least some frames assembled this way are complete and uncorrupted.

So somehow some headers are disappearing?

Carl


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006628.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
	<LI>Next message: <A HREF="006630.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6629">[ date ]</a>
              <a href="thread.html#6629">[ thread ]</a>
              <a href="subject.html#6629">[ subject ]</a>
              <a href="author.html#6629">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">More information about the Linux-uvc-devel
mailing list</a><br>
</body></html>
