<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Linux-uvc-devel] Quanta integrated webcam
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/linux-uvc-devel/2011-June/index.html" >
   <LINK REL="made" HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Quanta%20integrated%20webcam&In-Reply-To=%3C1307866833.5899.15.camel%40mini%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006587.html">
   <LINK REL="Next"  HREF="006593.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Linux-uvc-devel] Quanta integrated webcam</H1>
    <B>Alexey Fisher</B> 
    <A HREF="mailto:linux-uvc-devel%40lists.berlios.de?Subject=Re%3A%20%5BLinux-uvc-devel%5D%20Quanta%20integrated%20webcam&In-Reply-To=%3C1307866833.5899.15.camel%40mini%3E"
       TITLE="[Linux-uvc-devel] Quanta integrated webcam">bug-track at fisher-privat.net
       </A><BR>
    <I>Sun Jun 12 10:20:33 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="006587.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
        <LI>Next message: <A HREF="006593.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6589">[ date ]</a>
              <a href="thread.html#6589">[ thread ]</a>
              <a href="subject.html#6589">[ subject ]</a>
              <a href="author.html#6589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am Samstag, den 11.06.2011, 23:33 -0700 schrieb Carl Michal:
&gt;<i> 
</I>&gt;<i> On Sun, 12 Jun 2011, Alexey Fisher wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; On Sa, 2011-06-11 at 21:55 -0700, Carl Michal wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  2011/6/7 Alexey Fisher &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">bug-track at fisher-privat.net</A>&gt;:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;  On Mo, 2011-06-06 at 17:31 -0700, Carl Michal wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  Hello,
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  I'm having some trouble with a Quanta integrated webcam.  It
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  identifies
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  itself as: Laptop_Integrated_Webcam_2HDM, usbid: 0408:2fb1.  This is
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  built
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  in to a Dell XPS-15 (L501X).
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  The uvcvideo module works, but the video stutters and has some
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  distortions, even at low resolutions and frame rates.
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  With the Camera Output set to MJPG (in guvcview) &quot;Ignoring empty
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  buffer ...&quot;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  messages occur with most glitches.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  I would say the camera is not returning the full frame (or maybe empty
</I>&gt;<i> &gt;&gt;&gt;&gt;  ones) for same reason.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  If the output is set to YV12, the errors look like:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  VIDIOC_DQBUF - Unable to dequeue buffer : Input/output error
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  Error grabbing image
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  libv4l2: error converting / decoding frame data: v4l-convert: error
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  parsing JPEG header: Not a JPG file ?
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  YV12 is a format returned by libv4l, and it's obtained by
</I>&gt;<i> &gt;&gt;&gt;&gt;  decompressing the MJPG stream, so in fact the camera is still in MJPG
</I>&gt;<i> &gt;&gt;&gt;&gt;  format like above.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  With cheese, the video preview looks ok, but video capture is
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  unusable - the video stutters badly at low resolution, and the capture
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  hangs at high resolution (the program doesn't hang, but after a couple
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  of
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;&gt;  frames no more get captured).
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  Probably the same situation as above (incomplete or empty frames)
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  You should also increase uvc video verbosity and check dmesg for errors.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  From the looks of it I would say you are having some hardware sync
</I>&gt;<i> &gt;&gt;&gt;&gt;  issues, did you try all possible resolutions and frame rates ?
</I>&gt;<i> &gt;&gt;&gt;&gt;  Do these issues happen in all formats
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;  Regards,
</I>&gt;<i> &gt;&gt;&gt;&gt;  Paulo
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I've looked through the traces I've gotten with this webcam a little and
</I>&gt;<i> &gt;&gt; noticed something that may help.  The out of sync errors are always starts
</I>&gt;<i> &gt;&gt; with a sequence like this:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Frame complete (EOF found) buf: 1, bytes: 64684.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: EOF in empty payload.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_DQBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Dequeuing buffer 1 (4, 64684 bytes).
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_QBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Queuing buffer 1.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Frame complete (EOF found) buf: 2, bytes: 64728.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: EOF in empty payload.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_DQBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Dequeuing buffer 2 (4, 64728 bytes).
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_QBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Queuing buffer 2.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Frame complete (FID bit toggled) buf: 3, bytes: 63504.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Frame complete (EOF found) buf: 0, bytes: 1072.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: EOF in empty payload.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_DQBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Dequeuing buffer 3 (4, 63504 bytes).
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_QBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Queuing buffer 3.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_DQBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Dequeuing buffer 0 (4, 1072 bytes).
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_ioctl(VIDIOC_QBUF)
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Queuing buffer 0.
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: uvc_v4l2_poll
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Dropping payload (out of sync).
</I>&gt;<i> &gt;&gt; Jun 11 21:41:59 uvcvideo: Dropping payload (out of sync).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I've added a couple of fields to the frame complete messages to indicate
</I>&gt;<i> &gt;&gt; which buffer is marked as complete and how many bytes were delivered to
</I>&gt;<i> &gt;&gt; it.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Most frames are terminated with EOF, but occasionally an FID and EOF
</I>&gt;<i> &gt;&gt; are found in the same packet. So two buffers are marked as completed, but
</I>&gt;<i> &gt;&gt; the second one shouldn't be (I don't think).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Any advice on where to look next?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Try fid quirk:
</I>&gt;<i> &gt; uvcvideo quirks=0x10
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; for more quirks see:
</I>&gt;<i> &gt; grep QUIRK linux-2.6/drivers/media/video/uvc/uvcvideo.h
</I>&gt;<i> &gt; UVC_QUIRK_STATUS_INTERVAL 0x00000001
</I>&gt;<i> &gt; UVC_QUIRK_PROBE_MINMAX 0x00000002
</I>&gt;<i> &gt; UVC_QUIRK_PROBE_EXTRAFIELDS 0x00000004
</I>&gt;<i> &gt; UVC_QUIRK_BUILTIN_ISIGHT 0x00000008
</I>&gt;<i> &gt; UVC_QUIRK_STREAM_NO_FID 0x00000010
</I>&gt;<i> &gt; UVC_QUIRK_IGNORE_SELECTOR_UNIT 0x00000020
</I>&gt;<i> &gt; UVC_QUIRK_FIX_BANDWIDTH 0x00000080
</I>&gt;<i> &gt; UVC_QUIRK_PROBE_DEF 0x00000100
</I>&gt;<i> &gt; UVC_QUIRK_RESTRICT_FRAME_RATE 0x00000200
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -- 
</I>&gt;<i> &gt; Regards,
</I>&gt;<i> &gt;        Alexey
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> the fid quirk actually makes it quite a bit worse - many more out of sync 
</I>&gt;<i> errors.  None of the other quirks (individually) solve the issue.
</I>&gt;<i> 
</I>&gt;<i> I stuck in a crude hack to ignore the EOF that is found in the same packet 
</I>&gt;<i> as the fid toggle, and then the number of sync errors is dramatically 
</I>&gt;<i> reduced, but there are still some bad frames.  What next?
</I>
Am i correct, your trace is for mjpeg format?
Becouse buffers have different size, with uncompressed stream should get
always same size.
There are two way to mark frame as complete, at frame beginning (FID) or
at frame end (EOF). EOF is optional, FID is important. Some cams do not
do FID or brake it, in this case we use QUIRK_NO_FID, so EOF is used.
But we do not have EOF quirk. Let us try to ignore EOF, there is
attached patch.

-- 
Regards,
        Alexey
-------------- next part --------------
A non-text attachment was scrubbed...
Name: tmp.diff
Type: text/x-patch
Size: 889 bytes
Desc: not available
URL: &lt;<A HREF="https://lists.berlios.de/pipermail/linux-uvc-devel/attachments/20110612/ad0d5281/attachment.bin">https://lists.berlios.de/pipermail/linux-uvc-devel/attachments/20110612/ad0d5281/attachment.bin</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006587.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
	<LI>Next message: <A HREF="006593.html">[Linux-uvc-devel] Quanta integrated webcam
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6589">[ date ]</a>
              <a href="thread.html#6589">[ thread ]</a>
              <a href="subject.html#6589">[ subject ]</a>
              <a href="author.html#6589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/linux-uvc-devel">More information about the Linux-uvc-devel
mailing list</a><br>
</body></html>
